<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Mymillios</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/xp.css">
  <style>
    /* ENTRY POPUP */
    #entry-popup {
      position: fixed; top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.8);
      display:flex; align-items:center; justify-content:center;
      z-index:1000;
    }
    #entry-popup .popup-modal {
      background:#C0C0C0;
      border:4px solid #000080;
      padding:2rem;
      text-align:center;
      font-family:'Press Start 2P',monospace;
      color:#000;
    }
    #entry-popup button {
      margin:0 .5rem;
      padding:.5rem 1rem;
      font-size:1rem;
      border:2px solid #000;
      background:#fff;
      border-radius:8px;
      cursor:pointer;
    }

    /* FLOATING CHARACTERS */
    #background-container {
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      pointer-events:none;
      overflow:hidden;
      z-index:0;
    }
    .float-char {
      position:absolute;
      width:80px;
      opacity:0.5;
      animation-name: drift;
      animation-timing-function: linear;
      animation-iteration-count: infinite;
    }
    @keyframes drift {
      from { transform: translateX(0); }
      to   { transform: translateX(110vw); }
    }

    /* MAIN CONTENT (above floats) */
    .main-container {
      position:relative;
      z-index:1;
      text-align:center;
      padding-top:2rem;
    }
    .window { margin:auto; width:90%; max-width:500px; }
    .window-body { padding:1rem; }
    #combo-container img { max-width:100%; }

    /* AUDIO CONTROLS & PLAYLIST are unchanged… */
    /* …copy your previous styles here… */
  </style>
</head>
<body>
  <!-- Floating chars -->
  <div id="background-container"></div>

  <!-- Entry Popup -->
  <div id="entry-popup">
    <div class="popup-modal">
      <h2>Enter Sketch Wrld?</h2>
      <button id="enter-yes">Yes</button>
      <button id="enter-no">No</button>
    </div>
  </div>

  <div class="main-container">
    <h1 id="site-title">My<span>m</span>illios</h1>

    <div class="window">
      <div class="title-bar">mymillio generatoor</div>
      <div class="window-body">
        <div id="combo-container">
          {% for layer in layers %}
            <img id="layer-{{layer}}" src="" alt="" />
          {% endfor %}
        </div>
        <div class="buttons">
          <button id="randomize-btn">Randomize!</button>
          <button id="download-btn">Download Layers</button>
        </div>
      </div>
    </div>

    <!-- Playlist & Audio Controls… -->
    <!-- copy your #playlist-container and #audio-controls markup here -->
  </div>

  <script>
    const layerFiles = {{ layer_files|tojson }};
    const layers     = {{ layers|tojson }};

    // 1) Build 10 floating characters on load (only once)
    function generateBackgroundFloats() {
      const container = document.getElementById('background-container');
      for (let i = 0; i < 10; i++) {
        // pick one random combo
        const picks = layers.map(layer => {
          const opts = layerFiles[layer];
          return opts[ Math.floor(Math.random()*opts.length) ];
        });

        // draw & noise on a temp canvas
        const canvas = document.createElement('canvas');
        const img0 = new Image();
        img0.crossOrigin = 'anonymous';
        img0.onload = () => {
          // assume all source layers same size
          const w = img0.width, h = img0.height;
          canvas.width = w; canvas.height = h;
          const ctx = canvas.getContext('2d');

          // draw each layer in order
          picks.forEach((file, idx) => {
            const img = new Image();
            img.crossOrigin='anonymous';
            img.src = `/static/${layers[idx]}/${file}`;
            ctx.drawImage(img,0,0);
          });

          // add 50% noise
          const id = ctx.getImageData(0,0,w,h), d = id.data;
          for (let j=0; j<d.length; j+=4) {
            const noise = (Math.random()-0.5)*255*0.5;
            d[j]   = d[j]   + noise;
            d[j+1] = d[j+1] + noise;
            d[j+2] = d[j+2] + noise;
          }
          ctx.putImageData(id,0,0);

          // create float <img>
          const fc = document.createElement('img');
          fc.className = 'float-char';
          fc.src = canvas.toDataURL();
          // random vertical start
          fc.style.top = Math.random()*90 + 'vh';
          fc.style.left = '-10vw';
          // random speed between 25–45s
          fc.style.animationDuration = (25 + Math.random()*20) + 's';
          // random delay up to 30s
          fc.style.animationDelay = (Math.random()*30) + 's';
          container.appendChild(fc);
        };
        // trigger load
        img0.src = `/static/${layers[0]}/${picks[0]}`;
      }
    }

    // 2) Randomize only the central combo (no floats)
    function randomizeCombo() {
      layers.forEach(layer => {
        const opts = layerFiles[layer];
        if (!opts || !opts.length) return;
        const pick = opts[ Math.floor(Math.random()*opts.length) ];
        document.getElementById(`layer-${layer}`).src =
          `/static/${layer}/${pick}`;
      });
    }

    // 3) Download layers unchanged
    function downloadLayers() {
      layers.forEach(layer => {
        const url = document.getElementById(`layer-${layer}`).src;
        if (!url) return;
        const a = document.createElement('a');
        a.href = url;
        a.download = url.split('/').pop();
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      generateBackgroundFloats();

      const popup    = document.getElementById('entry-popup');
      const controls = document.getElementById('audio-controls');
      const audio    = new Audio('/static/song1.mp3');
      audio.loop     = true;
      audio.volume   = 0.5;

      document.getElementById('enter-yes').onclick = () => {
        popup.style.display    = 'none';
        controls.style.display = 'flex';
        randomizeCombo();
        audio.play();
      };
      document.getElementById('enter-no').onclick = () => {
        popup.style.display    = 'none';
        controls.style.display = 'flex';
        randomizeCombo();
      };

      document.getElementById('randomize-btn').onclick = randomizeCombo;
      document.getElementById('download-btn').onclick = downloadLayers;

      // …and wire up play/stop/mute/vol & playlist exactly as before…
    });
  </script>
</body>
</html>
