<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mymillios</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/xp.css">
  <style>
    /* ENTRY POPUP */
    #entry-popup {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #entry-popup .popup-modal {
      background: #C0C0C0;
      border: 4px solid #000080;
      padding: 2rem;
      text-align: center;
      font-family: 'Press Start 2P', monospace;
      color: #000;
    }
    #entry-popup h2 {
      margin-bottom: 1.5rem;
      font-size: 1.25rem;
    }
    #entry-popup button {
      margin: 0 .5rem;
      padding: .5rem 1rem;
      font-size: 1rem;
      cursor: pointer;
      border: 2px solid #000;
      background: #FFF;
      border-radius: 8px;
    }

    /* AUDIO CONTROLS */
    #audio-controls {
      position: fixed;
      bottom: 1rem; right: 1rem;
      display: none;
      gap: .5rem;
      z-index: 999;
    }
    #audio-controls button {
      font-size: 2rem;
      background: none;
      border: none;
      cursor: pointer;
      padding: .2rem;
    }

    /* PLAYLIST */
    #playlist-container {
      font-family: 'Press Start 2P', monospace;
      font-size: 0.75rem;
      margin: 1rem auto;
      text-align: center;
    }
    #playlist-title {
      cursor: default;
    }
    #playlist {
      list-style: none;
      padding: 0.5rem;
      margin: 0.5rem 0 0;
      display: flex;
      justify-content: center;
      gap: 1rem;
    }
    #playlist li {
      cursor: pointer;
      text-decoration: underline;
    }

    /* SCALE UP ON DESKTOP */
    @media (min-width: 768px) {
      .window {
        transform: scale(1.25);
        transform-origin: top center;
      }
    }

    /* ‚Äî‚Äî NEW: make sure your layers overlay properly ‚Äî‚Äî */
    #combo-container {
      position: relative;
      width: 790px;   /* match your IMAGE_SIZE */
      height: 875px;
      margin: 1rem auto;
      background: #eee;
    }
    #combo-container img {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <!-- Entry Popup -->
  <div id="entry-popup">
    <div class="popup-modal">
      <h2>Enter Sketch Wrld?</h2>
      <button id="enter-yes">Yes</button>
      <button id="enter-no">No</button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-container">
    <h1 id="site-title">My<span>m</span>illios</h1>
    <div class="window">
      <div class="title-bar">mymillio generatoor</div>
      <div class="window-body">
        <div id="combo-container">
          {% for layer in layers %}
            <img
              id="layer-{{ layer }}"
              src=""
              alt="{{ layer }}"
              {% if layer == 'health' %}style="opacity:0.3;"{% endif %} />
          {% endfor %}
        </div>
        <div class="buttons">
          <button id="randomize-btn">Randomize!</button>
          <button id="download-btn">Download Layers</button>
        </div>
      </div>
    </div>

    <!-- Playlist -->
    <div id="playlist-container">
      <div id="playlist-title">Sketchymillio EP1</div>
      <ul id="playlist">
        <li data-src="/static/song1.mp3">Song1</li>
        <li data-src="/static/song2.mp3">Song2</li>
        <li data-src="/static/song3.mp3">Song3</li>
      </ul>
    </div>
  </div>

  <!-- Audio Controls -->
  <div id="audio-controls">
    <button id="play-btn">‚ñ∂Ô∏è</button>
    <button id="stop-btn">‚èπÔ∏è</button>
    <button id="mute-btn">üîá</button>
    <button id="vol-down-btn">üîâ</button>
    <button id="vol-up-btn">üîä</button>
  </div>

  <script>
    const layerFiles = {{ layer_files | tojson }};
    const layers     = {{ layers | tojson }};

    function randomizeCombo() {
      const valid = layers.filter(l => (layerFiles[l]||[]).length);
      valid.forEach(layer => {
        const opts = layerFiles[layer];
        const pick = opts[Math.floor(Math.random()*opts.length)];
        const imgEl = document.getElementById(`layer-${layer}`);
        const temp = new Image();
        temp.crossOrigin = 'anonymous';
        temp.onload = () => {
          const w=temp.width, h=temp.height;
          const c=document.createElement('canvas');
          c.width=w; c.height=h;
          const ctx=c.getContext('2d');
          ctx.drawImage(temp,0,0);
          // only add noise to non-health layers
          if (layer!=='health') {
            const id=ctx.getImageData(0,0,w,h);
            const d=id.data;
            for (let i=0;i<d.length;i+=4){
              const n=(Math.random()-0.5)*255*0.5;
              d[i]+=n; d[i+1]+=n; d[i+2]+=n;
            }
            ctx.putImageData(id,0,0);
          }
          imgEl.src = c.toDataURL();
        };
        temp.src = `/static/${layer}/${pick}`;
      });
    }

    function downloadLayers() {
      layers.forEach(layer=>{
        const url=document.getElementById(`layer-${layer}`).src;
        if (!url) return;
        const a=document.createElement('a');
        a.href=url;
        a.download=url.split('/').pop();
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      });
    }

    document.addEventListener('DOMContentLoaded',()=>{
      const audio = new Audio('/static/song1.mp3');
      audio.loop=true; audio.volume=0.5;

      const popup    = document.getElementById('entry-popup');
      const controls = document.getElementById('audio-controls');

      document.getElementById('enter-yes').onclick = ()=>{
        popup.style.display='none';
        controls.style.display='flex';
        randomizeCombo();
        audio.play();
      };
      document.getElementById('enter-no').onclick = ()=>{
        popup.style.display='none';
        controls.style.display='flex';
        randomizeCombo();
      };

      document.getElementById('randomize-btn').onclick = randomizeCombo;
      document.getElementById('download-btn').onclick   = downloadLayers;

      document.getElementById('play-btn').onclick     = ()=> audio.play();
      document.getElementById('stop-btn').onclick     = ()=>{ audio.pause(); audio.currentTime=0; };
      document.getElementById('mute-btn').onclick     = ()=> audio.muted = !audio.muted;
      document.getElementById('vol-down-btn').onclick = ()=> audio.volume = Math.max(0,audio.volume-0.1);
      document.getElementById('vol-up-btn').onclick   = ()=> audio.volume = Math.min(1,audio.volume+0.1);

      document.querySelectorAll('#playlist li').forEach(li=>{
        li.onclick = ()=>{
          audio.pause();
          audio.src = li.dataset.src;
          audio.play();
        };
      });
    });
  </script>
</body>
</html>
