<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mymillios</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/xp.css">
  <style>
    /* ENTRY POPUP */
    #entry-popup {
      position: fixed; top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.8);
      display:flex; align-items:center; justify-content:center;
      z-index:1000;
    }
    #entry-popup .popup-modal {
      background:#C0C0C0; border:4px solid #000080;
      padding:2rem; text-align:center;
      font-family:'Press Start 2P'; color:#000;
    }
    #entry-popup button {
      margin:0 .5rem; padding:.5rem 1rem;
      font-size:1rem; cursor:pointer;
      border:2px solid #000; background:#FFF;
      border-radius:8px;
    }

    /* COMBO CONTAINER */
    #combo-container {
      position: relative;
      width: 790px;
      height: 875px;
      margin: 1rem auto;
      overflow: hidden;
    }
    #combo-container img {
      position: absolute;
      top: 0; left: 0;
      width: 790px; height: 875px;
      image-rendering: crisp-edges;
    }

    /* FILTERS */
    #filter-select {
      display: block;
      margin: .5rem auto 1rem;
      font-family:'Press Start 2P';
    }
    /* Heavy CRT effect */
    #combo-container.filter-crt-heavy img {
      filter: contrast(200%) brightness(75%) saturate(150%);
    }
    #combo-container.filter-crt-heavy::after {
      content: '';
      position: absolute; top:0; left:0;
      width:100%; height:100%;
      pointer-events: none;
      background-image:
        repeating-linear-gradient(rgba(0,0,0,0.15) 0 2px, transparent 2px 4px),
        radial-gradient(circle at center, rgba(255,255,255,0.05), transparent 70%);
      mix-blend-mode: overlay;
    }
    /* Simple scanlines */
    #combo-container.filter-scanlines::after {
      content: '';
      position: absolute; top:0; left:0;
      width:100%; height:100%;
      pointer-events: none;
      background-image:
        repeating-linear-gradient(rgba(0,0,0,0.1) 0 1px, transparent 1px 3px);
    }

    /* BUTTONS */
    .buttons {
      text-align:center; margin-bottom:1.5rem;
    }
    .buttons button {
      font-family:'Press Start 2P';
      padding:.5rem 1rem; margin:0 .5rem;
    }

    /* FLOATS */
    .bg-float {
      position:absolute; pointer-events:none; opacity:.5;
    }
  </style>
</head>
<body>
  <!-- Entry Popup -->
  <div id="entry-popup">
    <div class="popup-modal">
      <h2>Enter Sketch Wrld?</h2>
      <button id="enter-yes">Yes</button>
      <button id="enter-no">No</button>
    </div>
  </div>

  <!-- Floating Background -->
  <div id="background-container"></div>

  <!-- Main Generator -->
  <div class="main-container">
    <h1 style="text-align:center; font-family:'Press Start 2P';">
      My<span style="color:#f00;">m</span>illios
    </h1>
    <div class="window">
      <div class="title-bar">mymillio generatoor</div>
      <div class="window-body">
        <div id="combo-container">
          {% for layer in layers %}
            <img id="layer-{{layer}}" src="" alt="" />
          {% endfor %}
        </div>
        <select id="filter-select">
          <option value="">No filter</option>
          <option value="crt-heavy">Heavy CRT</option>
          <option value="scanlines">Scanlines</option>
        </select>
        <div class="buttons">
          <button id="randomize-btn">Randomize!</button>
          <button id="download-btn">Download Layers</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Audio & Popup Logic -->
  <script>
    const layers     = {{ layers|tojson }};
    const layerFiles = {{ layer_files|tojson }};

    // spawn background floats
    function spawnBackground() {
      const bg = document.getElementById('background-container');
      bg.innerHTML = '';
      layers.forEach(layer => {
        const el = document.getElementById(`layer-${layer}`);
        if (!el.src) return;
        const f = el.cloneNode();
        f.className = 'bg-float';
        f.style.top = Math.random()*100 + '%';
        f.style.left = Math.random()*100 + '%';
        f.style.transform = `translate(-50%,-50%) scale(${0.1+Math.random()*0.2}) rotate(${Math.random()*360}deg)`;
        bg.appendChild(f);
      });
    }

    // randomize layers
    function randomize() {
      layers.forEach(layer => {
        const opts = layerFiles[layer] || [];
        if (!opts.length) return;
        const pick = opts[Math.floor(Math.random()*opts.length)];
        document.getElementById(`layer-${layer}`).src = `/static/${layer}/${pick}`;
      });
      spawnBackground();
    }

    // download each layer
    function downloadLayers() {
      layers.forEach(layer => {
        const el = document.getElementById(`layer-${layer}`);
        if (!el.src) return;
        const a = document.createElement('a');
        a.href = el.src;
        a.download = el.src.split('/').pop();
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      const popup = document.getElementById('entry-popup');
      const audio = new Audio('/static/song1.mp3');
      audio.loop = true;
      audio.volume = 0.5;

      document.getElementById('enter-yes').onclick = () => {
        popup.style.display = 'none';
        audio.play();
      };
      document.getElementById('enter-no').onclick = () => {
        popup.style.display = 'none';
      };

      document.getElementById('randomize-btn').onclick = randomize;
      document.getElementById('download-btn').onclick = downloadLayers;

      document.getElementById('filter-select').onchange = e => {
        const combo = document.getElementById('combo-container');
        combo.className = e.target.value ? `filter-${e.target.value}` : '';
      };

      // initial
      randomize();
    });
  </script>
</body>
</html>
